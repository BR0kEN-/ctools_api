language: php

addons:
  apt:
    packages:
      - apache2
      - libapache2-mod-fastcgi

services:
  - mysql

php:
  - 5.6
  - 7.0
  - 7.1

env:
  global:
    - DRUPAL_TEST_MODULE_NAME: ctools_api
    # See "composer.json" to understand where the "drupal/" prefix comes from.
    - DRUPAL_TEST_MODULE_LOCATION: drupal/sites/all/modules/contrib
    - DRUPAL_TEST_DATABASE_NAME: drupal

# https://docs.travis-ci.com/user/database-setup/#MySQL
mysql:
  database: drupal
  username: travis
  encoding: utf8

before_install:
  - env
  # Go to the directory where everything will happen.
  - cd ./tests/travis
  # Inject custom PHP configuration.
  - phpenv config-add php/php.ini
  # Install dependencies.
  - composer install
  # Compute facts.
  - export CWD="$(pwd -P)"
  - export PATH="$CWD/bin:$PATH"
  - export TRAVIS_BUILD_DIR_OLD="$TRAVIS_BUILD_DIR"
  - export TRAVIS_BUILD_DIR="$CWD/$DRUPAL_TEST_MODULE_LOCATION/$DRUPAL_TEST_MODULE_NAME"
  # Ensure the directory for project exists.
  - mkdir -p "$TRAVIS_BUILD_DIR"
  # Relocate the project.
  - rsync -ra --delete --exclude="${CWD//$TRAVIS_BUILD_DIR_OLD\//}" "$TRAVIS_BUILD_DIR_OLD" "$TRAVIS_BUILD_DIR"
  # Discover available coding standards.
  - phpcs --config-set installed_paths "$(find "$CWD/vendor/" -type f -name "ruleset.xml" -exec dirname {} \; | xargs dirname | uniq | paste -sd "," -)"
  # Enable Apache modules.
  - sudo a2enmod rewrite actions fastcgi alias
  - sudo service apache2 restart
#  - |-
#    cd ./tests/travis
#
#    echo "==> Inject custom PHP configuration."
#    phpenv config-add php/php.ini
#
#    echo "==> Install dependencies."
#    composer install
#
#    echo "==> Compute facts."
#    export CWD="$(pwd -P)"
#    # Make our packages observable.
#    export PATH="$CWD/bin:$PATH"
#    # Save the old location.
#    export TRAVIS_BUILD_DIR_OLD="$TRAVIS_BUILD_DIR"
#    # Override the path to directory with a build.
#    export TRAVIS_BUILD_DIR="$CWD/$DRUPAL_TEST_MODULE_LOCATION/$DRUPAL_TEST_MODULE_NAME"
#
#    echo "==> Ensure the directory for project exists."
#    mkdir -p "$TRAVIS_BUILD_DIR"
#
#    echo "==> Relocate the project."
#    rsync -ra --delete --exclude="${CWD//$TRAVIS_BUILD_DIR_OLD\//}" "$TRAVIS_BUILD_DIR_OLD" "$TRAVIS_BUILD_DIR"
#
#    echo "==> Discover available coding standards."
#    phpcs --config-set installed_paths "$(find "$CWD/vendor/" -type f -name "ruleset.xml" -exec dirname {} \; | xargs dirname | uniq | paste -sd "," -)"
#
#    echo "==> Configure Apache web-server."
#    sudo a2enmod rewrite actions fastcgi alias
#    sudo service apache2 restart

install:
  - pwd
  - echo "$TRAVIS_BUILD_DIR"
  - phpcs "$TRAVIS_BUILD_DIR" --runtime-set testVersion "$TRAVIS_PHP_VERSION"
  - drush si minimal --db-url="mysql://$USER:@127.0.0.1/$DRUPAL_TEST_DATABASE_NAME" -y -v

script:
  - drush en "$DRUPAL_TEST_MODULE_NAME" -y
